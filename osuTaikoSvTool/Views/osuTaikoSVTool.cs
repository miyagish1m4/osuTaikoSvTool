using System.Diagnostics;
using OsuMemoryDataProvider;
using OsuMemoryDataProvider.OsuMemoryModels;
using OsuParsers.Decoders;
using osuTaikoSvTool.Models;
using osuTaikoSvTool.Properties;
using osuTaikoSvTool.Services;
using osuTaikoSvTool.Utils;
using osuTaikoSvTool.Utils.Helper;
using osuTaikoSvTool.Views;

namespace osuTaikoSvTool
{
    public partial class osuTaikoSVTool : Form
    {
        #region クラス変数
        private readonly StructuredOsuMemoryReader sreader = StructuredOsuMemoryReader.GetInstance(new("osu!"));
        private readonly OsuBaseAddresses baseAddresses = new OsuBaseAddresses();
        private BeatmapMetadata beatmapInfo = new();
        private BeatmapMetadata preBeatmapInfo = new();
        private Beatmap? beatmapData;
        private UserInputData userInputData = new();
        private UserInputTempData userInputTempData = new();
        private Config config = new();
        private List<TimingPoint> timingPoints = [];
        private string osuDirectory = string.Empty;
        private string songsPath = string.Empty;
        private int currentTime;
        private bool isDirectoryLoaded = false;
        private bool isUpdate = true;
        private string backupDirectoryName = string.Empty;
        #endregion
        #region メソッド
        /// <summary>
        /// コンストラクタ
        /// </summary>
        public osuTaikoSVTool()
        {
            InitializeComponent();
            Thread getMemoryDataThread = new Thread(UpdateMemoryData) { IsBackground = true };
            getMemoryDataThread.Start();

            UpdateBeatmapInfo();

        }
        /// <summary>
        /// osu.exeのメモリデータ取得処理
        /// </summary>
        private void UpdateMemoryData()
        {
            while (true)
            {
                try
                {
                    Thread.Sleep(15);
                    // osu.exeを探す
                    var processes = Process.GetProcessesByName("osu!");
                    if (processes.Length == 0)
                    {
                        if (isDirectoryLoaded)
                        {
                            beatmapInfo = new();
                        }
                        isDirectoryLoaded = false;
                        throw new Exception("osu!が起動されていません。");
                    }
                    // osuフォルダ取得処理
                    if (!isDirectoryLoaded)
                    {
                        Process process = processes[0];
                        string? fileName = process.MainModule?.FileName;
                        osuDirectory = Path.GetDirectoryName(fileName) ?? string.Empty;
                        if (osuDirectory != string.Empty)
                        {
                            if (!Directory.Exists(osuDirectory))
                            {
                                return;
                            }
                            songsPath = Common.GetSongsFolderLocation(osuDirectory);
                            isDirectoryLoaded = !isDirectoryLoaded;
                        }
                    }
                    // メモリから譜面の情報を取得する
                    sreader.TryRead(baseAddresses.Beatmap);
                    sreader.TryRead(baseAddresses.GeneralData);
                    currentTime = baseAddresses.GeneralData.AudioTime;
                    // 譜面のフォルダを取得
                    string osuBeatmapPath = Path.Combine(songsPath ?? "",
                                                         baseAddresses.Beatmap.FolderName ?? "",
                                                         baseAddresses.Beatmap.OsuFileName ?? "");
                    // 譜面のデータを取得
                    OsuParsers.Beatmaps.Beatmap beatmapData = BeatmapDecoder.Decode(osuBeatmapPath);
                    // タイトル
                    beatmapInfo.title = beatmapData.Version <= 9 ? beatmapData.MetadataSection.Title : beatmapData.MetadataSection.TitleUnicode;
                    // アーティスト
                    beatmapInfo.artist = beatmapData.Version <= 9 ? beatmapData.MetadataSection.Artist : beatmapData.MetadataSection.ArtistUnicode;
                    // Diff名
                    beatmapInfo.version = beatmapData.MetadataSection.Version;
                    // マッパー名
                    beatmapInfo.creator = beatmapData.MetadataSection.Creator;
                    // 譜面のパス
                    beatmapInfo.beatmapPath = osuBeatmapPath;
                    // BGのパス
                    string backgroundPath = Path.Combine(songsPath ?? "",
                                                         baseAddresses.Beatmap.FolderName ?? "",
                                                         beatmapData.EventsSection.BackgroundImage ?? "");
                    beatmapInfo.backgroundPath = backgroundPath ?? "";
                    if (isUpdate)
                    {
                        isUpdate = false;
                    }
                }
                catch (Exception ex)
                {
                    // このExceptionはErrorログに書き込むと容量が膨大になってしまうため、
                    // Errorログには書かずConsoleログに出力
                    Console.WriteLine(ex);
                }
            }
        }
        /// <summary>
        /// UpdateMemoryDataで取得したosuのメモリデータを使用し、
        /// 譜面のBGやMetadataをコントロールに設定する
        /// </summary>
        private async void UpdateBeatmapInfo()
        {
            while (true)
            {
                await Task.Delay(15);

                try
                {
                    if (isUpdate)
                    {
                        continue;
                    }
                    // 前回取得したデータと同じ場合は処理を行わない
                    if (preBeatmapInfo.version == beatmapInfo.version &&
                        preBeatmapInfo.beatmapPath == beatmapInfo.beatmapPath)
                    {
                        continue;
                    }
                    preBeatmapInfo.backgroundPath = beatmapInfo.backgroundPath ?? "";
                    preBeatmapInfo.artist = beatmapInfo.artist;
                    preBeatmapInfo.title = beatmapInfo.title;
                    preBeatmapInfo.version = beatmapInfo.version;
                    preBeatmapInfo.creator = beatmapInfo.creator;
                    // テキストラベルに譜面の情報を書き込む
                    lblFileName.Text = beatmapInfo.artist.Replace("&", "&&") +
                                       (beatmapInfo.artist == string.Empty ? "" : " - ") +
                                       beatmapInfo.title.Replace("&", "&&") +
                                       (beatmapInfo.title == string.Empty ? "" : " [") +
                                       beatmapInfo.version.Replace("&", "&&") +
                                       (beatmapInfo.version == string.Empty ? "" : "]");
                    // バックアップフォルダ名を設定する
                    backupDirectoryName = beatmapInfo.artist + " - " +
                                                             beatmapInfo.title + " (" +
                                                             beatmapInfo.creator + ") [" +
                                                             beatmapInfo.version + "]";
                    preBeatmapInfo.beatmapPath = beatmapInfo.beatmapPath;
                    // BGのパスが取得できている場合はBGをフォームに表示する
                    if (beatmapInfo.backgroundPath == null || beatmapInfo.backgroundPath == string.Empty)
                    {
                        picDisplayBg.Image = null;
                        Common.WriteWarningMessage("LOG_W-GET-BG");
                    }
                    else
                    {
                        picDisplayBg.Image = BeatmapHelper.SetBgOnForm(beatmapInfo.backgroundPath);
                    }
                }
                catch (Exception ex)
                {
                    // このExceptionはErrorログに書き込むと容量が膨大になってしまうため、
                    // Errorログには書かずConsoleログに出力
                    Console.WriteLine(ex);
                }
            }
        }
        /// <summary>
        /// コントロールの初期化処理
        /// </summary>
        private void InitializeControls()
        {
            picSpecificNormalDong.Visible = false;
            picSpecificFinisherDong.Visible = false;
            picSpecificNormalKa.Visible = false;
            picSpecificFinisherKa.Visible = false;
            picSpecificNormalSlider.Visible = false;
            picSpecificFinisherSlider.Visible = false;
            picSpecificNormalSpinner.Visible = false;
            lblSpecificNormal.Visible = false;
            lblSpecificFinisher.Visible = false;
            lblSpecificGridLine.Visible = false;
            lblSpecificGridLine2.Visible = false;
            rdoAllHitObjects.Checked = true;
            if (config.advanceMode == 1)
            {
                chkRelative.Visible = true;
            } else
            {
                chkRelative.Visible = false;
            }
        }
        /// <summary>
        /// 処理項目タブが"Objectsのみ"の時のコントロールの初期化処理
        /// </summary>
        private void InitializeHitObjectsControls()
        {
            rdoAllHitObjects.Checked = userInputTempData.setObjectOption.isAllHitObjects;
            rdoOnlyBarline.Checked = userInputTempData.setObjectOption.isOnlyBarlines;
            rdoOnlyBookMark.Checked = userInputTempData.setObjectOption.isOnlyBookmarks;
            rdoOnlySpecificHitObject.Checked = userInputTempData.setObjectOption.isOnlyHitObjects;
            Common.SetLabelText(chkEnableOffset, "LBL_APPLY_OFFSET");
        }
        /// <summary>
        /// 処理項目タブが"ビートスナップ間隔"の時のコントロールの初期化処理
        /// </summary>
        private void InitializeBeatSnapControls()
        {
            chkEnableBeatSnap.CheckedChanged -= chkEnableBeatSnap_CheckedChanged;
            chkEnableBeatSnap.Checked = userInputTempData.setBeatSnapOption.isBeatSnap;
            chkEnableBeatSnap.CheckedChanged += chkEnableBeatSnap_CheckedChanged;
            Common.SetLabelText(chkEnableOffset, "LBL_APPLY_OFFSET");
        }
        /// <summary>
        /// 処理項目タブが"緑線"の時のコントロールの初期化処理
        /// </summary>
        private void InitializeGreenLineControls()
        {
            Common.SetLabelText(chkEnableOffset, "LBL_START_OFFSET");
        }
        /// <summary>
        /// メイン処理(SV.Volume)
        /// </summary>
        /// <param name="executeCode">実行コード</param>
        private void ExecuteProcess(int executeCode)
        {
            bool isSvCalculation = false;
            // 入力値と譜面情報が取得できていない場合はエラーダイアログを表示する
            if (userInputData == null || beatmapData == null)
            {
                Common.ShowMessageDialog("E_A-D-001");
                return;
            }
            // 実行コードにSV処理を行う
            switch (executeCode)
            {
                // 適応
                case Constants.EXECUTE_APPLY:
                    isSvCalculation = SVCalculatorService.Apply(userInputData, beatmapData, ref timingPoints);
                    beatmapData.timingPoints.AddRange(timingPoints);
                    beatmapData.timingPoints = beatmapData.timingPoints.OrderBy(a => a.time).ThenByDescending(b => b.isRedLine ? 1 : 0).ToList();
                    timingPoints.Clear();
                    break;
                // 削除
                case Constants.EXECUTE_REMOVE:
                    isSvCalculation = SVCalculatorService.Remove(userInputData, beatmapData);
                    break;
            }
            if (!isSvCalculation)
            {
                // 失敗した場合はエラーダイアログを表示する
                Common.ShowMessageDialog("E_A-P-001");
                return;
            }
            // バックアップを作成する
            if (BeatmapHelper.CreateBackup(this.beatmapInfo.beatmapPath, this.backupDirectoryName))
            {
                if (!SettingHelper.ResetBackupFile(config) ||
                    !SettingHelper.ResetHistoryFile(config))
                {
                    // 失敗した場合はエラーダイアログを表示する
                    Common.ShowMessageDialog("E_A-P-001");
                    return;
                }
            }
            // デバッグ用CSV出力
            // 内容確認などに使ってね
            //if (!Utils.Helper.Debug.ExportToCsvFile(beatmapData, this.backupDirectoryName))
            // osuファイルに上書きする
            if (!BeatmapHelper.ExportToOsuFile(beatmapData, this.beatmapInfo.beatmapPath))
            {
                // 失敗した場合はエラーダイアログを表示する
                Common.ShowMessageDialog("E_A-P-001");
                return;
            }
            // 入力値をxmlファイルにシリアライズする
            if (!UserInputDataHelper.SerializeUserInputData(userInputData)
                // || !Utils.Helper.Debug.ExportToUserInputData(userInputData)
                )
            {
                // 失敗した場合はエラーダイアログを表示する
                Common.ShowMessageDialog("E_A-P-001");
                return;
            }
            // 成功した場合はメッセージダイアログを表示する
            Common.ShowMessageDialog("I_A-P-001", 1);
            this.Activate();
            return;
        }
        /// <summary>
        /// 譜面情報の取得処理
        /// </summary>
        /// <returns>処理が<br/>・正常終了した場合はtrue<br/>・異常終了した場合はfalse</returns>
        private bool GetBeatmap()
        {
            // 譜面情報がリアルタイムで取得できていない場合はエラーダイアログを表示する
            if (this.beatmapInfo.beatmapPath == null || this.beatmapInfo.beatmapPath == string.Empty)
            {
                return false;
            }
            // 譜面の内容を取得する
            beatmapData = BeatmapHelper.GetBeatmapData(this.beatmapInfo.beatmapPath);
            // 取得できなかった場合はエラーダイアログを表示する
            if (beatmapData.version == string.Empty)
            {
                return false;
            }
            return true;
        }
        /// <summary>
        /// 現地点の情報を取得する処理
        /// </summary>
        /// <param name="control">設定対象のコントロール</param>
        /// <param name="setCode">セットコード(0:Timing 1:SV 2:Volume)</param>
        private void SetCurrentTimeInfo(Control control, int setCode)
        {
            try
            {
                if (setCode != Constants.SET_TIMING)
                {
                    if (!GetBeatmap())
                    {
                        throw new Exception();
                    }
                }
                switch (setCode)
                {
                    case Constants.SET_TIMING:
                        control.Text = Common.ConvertFormatTiming(currentTime);
                        break;
                    case Constants.SET_SV:
                        control.Text = UserInputDataHelper.SetCurrentSv(beatmapData, currentTime);
                        break;
                    case Constants.SET_VOLUME:
                        control.Text = UserInputDataHelper.SetCurrentVolume(beatmapData, currentTime);
                        break;
                    default:
                        throw new Exception();
                }
            }
            catch
            {
                Common.WriteErrorMessage("LOG_E-GET-BEATMAP");
            }
            finally
            {
                beatmapData = null;
            }
        }
        /// <summary>
        /// コンフィグの初期化処理
        /// </summary>
        private void InitializeConfig()
        {
            config.ConfigLoad();
            Common.LoadConfig(config);
            this.Text = Constants.APP_NAME + " ver" + Constants.APP_VERSION;
        }
        /// <summary>
        /// ラベルテキストの初期化処理
        /// </summary>
        private void InitializeLabelText()
        {
            Common.SetLabelText(chkApplyStartObject, "LBL_APPLY_TIMING_FROM");
            Common.SetLabelText(chkApplyEndObject, "LBL_APPLY_TIMING_TO");
            Common.SetLabelText(lblCalculationType, "LBL_SV_CALC_METHOD");
            Common.SetLabelText(rdoArithmetic, "LBL_ARITHMETIC");
            Common.SetLabelText(rdoGeometric, "LBL_GEOMETRIC");
            Common.SetLabelText(chkRelative, "LBL_RELATIVE_MODE");
            Common.SetLabelText(rdoRelativeMultiply, "LBL_RELATIVE_MULTIPLY");
            Common.SetLabelText(rdoRelativeSum, "LBL_RELATIVE_SUM");
            Common.SetLabelText(lblRelativeBaseSv, "LBL_RELATIVE_BASESV");
            Common.SetLabelText(chkEnableSvTo, "LBL_RELATIVE_APPLY_TIMING_TO");
            Common.SetLabelText(tabApplyPage, "LBL_TAB_APPLY");
            if (tabSetType.SelectedIndex != 2)
            {
                Common.SetLabelText(chkEnableOffset, "LBL_APPLY_OFFSET");
            }
            else
            {
                Common.SetLabelText(chkEnableOffset, "LBL_START_OFFSET");
            }
            Common.SetLabelText(btnApply, "LBL_EXE_APPLY");
            Common.SetLabelText(tabHitObjectsPage, "LBL_TAB_ONLY_OBJECTS");
            Common.SetLabelText(tabBeatSnap, "LBL_TAB_BEATSNAP");
            Common.SetLabelText(tabGreenLine, "LBL_TAB_GREENLINE");
            Common.SetLabelText(rdoAllHitObjects, "LBL_ALL_HITOBJECT");
            Common.SetLabelText(rdoOnlyBarline, "LBL_BARLINE");
            Common.SetLabelText(rdoOnlyBookMark, "LBL_BOOKMARK");
            Common.SetLabelText(rdoOnlySpecificHitObject, "LBL_SPECIFIC_HITOBJECT");
            Common.SetLabelText(lblSpecificNormal, "LBL_NORMAL");
            Common.SetLabelText(lblSpecificFinisher, "LBL_FINISHER");
            Common.SetLabelText(chkEnableBeatSnap, "LBL_ENABLE_BEATSNAP");
            Common.SetLabelText(tabRemovePage, "LBL_TAB_DELETE");
            Common.SetLabelText(chkEnableStartOffset, "LBL_DELETE_OFFSET");
            Common.SetLabelText(btnRemove, "LBL_EXE_DELETE");
            Common.SetLabelText(btnBackup, "LBL_BACKUP");
            Common.SetLabelText(btnViewSetting, "LBL_SETTING");
        }
        /// <summary>
        /// SV始点テキストボックスの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetTxtSvFromEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                if (userInputTempData.isRelative)
                {
                    if (userInputTempData.isRelativeMultiply)
                    {
                        txtSvFrom.Text = userInputTempData.relativeMultiplySvFrom;
                    }
                    else if (userInputTempData.isRelativeSum)
                    {
                        txtSvFrom.Text = userInputTempData.relativeSumSvFrom;
                    }
                    else
                    {
                        txtSvFrom.Text = userInputTempData.svFrom;
                    }
                }
                else
                {
                    txtSvFrom.Text = userInputTempData.svFrom;
                }
                txtSvFrom.Enabled = true;
                txtSvFrom.BackColor = SystemColors.Window;
                txtSvFrom.ForeColor = SystemColors.WindowText;
            }
            else
            {
                txtSvFrom.Enabled = false;
                txtSvFrom.BackColor = SystemColors.WindowFrame;
                txtSvFrom.ForeColor = txtSvFrom.BackColor;
            }
        }
        /// <summary>
        /// SV終点テキストボックスの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetTxtSvToEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                txtSvTo.Enabled = true;
                txtSvTo.ForeColor = SystemColors.WindowText;
                txtSvTo.BackColor = SystemColors.Window;
            }
            else
            {
                txtSvTo.Enabled = false;
                txtSvTo.BackColor = SystemColors.WindowFrame;
                txtSvTo.ForeColor = txtSvTo.BackColor;
            }
        }
        /// <summary>
        /// SV入れ替えボタンの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetBtnSwapSvEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                btnSwapSv.Enabled = true;
                btnSwapSv.ForeColor = Color.Cyan;
                btnSwapSv.FlatAppearance.BorderColor = Color.Cyan;
            }
            else
            {
                btnSwapSv.Enabled = false;
                btnSwapSv.ForeColor = SystemColors.WindowFrame;
                btnSwapSv.FlatAppearance.BorderColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// 始点SV設定ボタンの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable"></param>
        private void SetBtnSetSvFromEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                btnSetSvFrom.Enabled = true;
                btnSetSvFrom.ForeColor = SystemColors.Control;
                btnSetSvFrom.FlatAppearance.BorderColor = Color.Cyan;
            }
            else
            {
                btnSetSvFrom.Enabled = false;
                btnSetSvFrom.ForeColor = SystemColors.WindowFrame;
                btnSetSvFrom.FlatAppearance.BorderColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// 終点SV設定ボタンの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable"></param>
        private void SetBtnSetSvToEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                btnSetSvTo.Enabled = true;
                btnSetSvTo.ForeColor = SystemColors.Control;
                btnSetSvTo.FlatAppearance.BorderColor = Color.Cyan;
            }
            else
            {
                btnSetSvTo.Enabled = false;
                btnSetSvTo.ForeColor = SystemColors.WindowFrame;
                btnSetSvTo.FlatAppearance.BorderColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// Volume始点テキストボックスの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetTxtVolumeFromEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                txtVolumeFrom.Enabled = true;
                txtVolumeFrom.ForeColor = SystemColors.WindowText;
                txtVolumeFrom.BackColor = SystemColors.Window;
            }
            else
            {
                txtVolumeFrom.Enabled = false;
                txtVolumeFrom.ForeColor = SystemColors.WindowFrame;
                txtVolumeFrom.BackColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// Volume終点テキストボックスの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetTxtVolumeToEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                txtVolumeTo.Enabled = true;
                txtVolumeTo.ForeColor = SystemColors.WindowText;
                txtVolumeTo.BackColor = SystemColors.Window;
            }
            else
            {
                txtVolumeTo.Enabled = false;
                txtVolumeTo.ForeColor = SystemColors.WindowFrame;
                txtVolumeTo.BackColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// Volume入れ替えボタンの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetBtnSwapVolumeEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                btnSwapVolume.Enabled = true;
                btnSwapVolume.ForeColor = Color.Cyan;
                btnSwapVolume.FlatAppearance.BorderColor = Color.Cyan;
            }
            else
            {
                btnSwapVolume.Enabled = false;
                btnSwapVolume.ForeColor = SystemColors.WindowFrame;
                btnSwapVolume.FlatAppearance.BorderColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// 始点Volume設定ボタンの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable"></param>
        private void SetBtnSetVolumeFromEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                btnSetVolumeFrom.Enabled = true;
                btnSetVolumeFrom.ForeColor = SystemColors.Control;
                btnSetVolumeFrom.FlatAppearance.BorderColor = Color.Cyan;
            }
            else
            {
                btnSetVolumeFrom.Enabled = false;
                btnSetVolumeFrom.ForeColor = SystemColors.WindowFrame;
                btnSetVolumeFrom.FlatAppearance.BorderColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// 終点Volume設定ボタンの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable"></param>
        private void SetBtnSetVolumeToEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                btnSetVolumeTo.Enabled = true;
                btnSetVolumeTo.ForeColor = SystemColors.Control;
                btnSetVolumeTo.FlatAppearance.BorderColor = Color.Cyan;
            }
            else
            {
                btnSetVolumeTo.Enabled = false;
                btnSetVolumeTo.ForeColor = SystemColors.WindowFrame;
                btnSetVolumeTo.FlatAppearance.BorderColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// 相対速度変化オプションの有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetRelativeEnabledState(bool isEnable)
        {
            if (isEnable)
            {
                pnlRelativeSvGroup.Visible = true;
                chkEnableSvTo.Visible = true;
                chkEnableSv.Enabled = false;
                rdoArithmetic.Enabled = false;
                rdoGeometric.Enabled = false;
                if (userInputTempData.isRelativeMultiply)
                {
                    txtSvFrom.Text = userInputTempData.relativeMultiplySvFrom;
                    txtSvTo.Text = userInputTempData.relativeMultiplySvTo;
                }
                else if (userInputTempData.isRelativeSum)
                {
                    txtSvFrom.Text = userInputTempData.relativeSumSvFrom;
                    txtSvTo.Text = userInputTempData.relativeSumSvTo;
                }
            }
            else
            {
                pnlRelativeSvGroup.Visible = false;
                chkEnableSvTo.Visible = false;
                chkEnableSv.Enabled = true;
                rdoArithmetic.Enabled = true;
                rdoGeometric.Enabled = true;
                txtSvFrom.Text = userInputTempData.svFrom;
                txtSvTo.Text = userInputTempData.svTo;
            }
        }
        /// <summary>
        /// 相対速度変化オプション(乗算)の有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetRelativeMultiplyEnableState(bool isEnable)
        {
            if (isEnable)
            {
                txtRelativeBaseSv.Enabled = true;
                txtRelativeBaseSv.ForeColor = SystemColors.WindowText;
                txtRelativeBaseSv.BackColor = SystemColors.Window;
                txtSvFrom.Text = userInputTempData.relativeMultiplySvFrom;
                txtSvTo.Text = userInputTempData.relativeMultiplySvTo;
            }
            else
            {
                txtRelativeBaseSv.Enabled = false;
                txtRelativeBaseSv.ForeColor = SystemColors.WindowFrame;
                txtRelativeBaseSv.BackColor = SystemColors.WindowFrame;
            }
        }
        /// <summary>
        /// Offset有効化チェックボックス(適応)の有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetChkEnableOffset(bool isEnable)
        {
            if (isEnable)
            {
                txtOffset.ForeColor = SystemColors.WindowText;
                txtOffset.BackColor = SystemColors.Window;
                txtOffset.Enabled = true;
            }
            else
            {
                txtOffset.ForeColor = SystemColors.WindowFrame;
                txtOffset.BackColor = SystemColors.WindowFrame;
                txtOffset.Enabled = false;
            }
        }
        /// <summary>
        /// 処理項目タブが"適応"の時のコントロールの初期化処理
        /// </summary>
        private void SetApplyControls(bool isEnable)
        {
            chkRelative.Visible = isEnable;
            chkEnableSv.Enabled = isEnable;
            chkEnableVolume.Enabled = isEnable;
            chkApplyStartObject.Enabled = isEnable;
            chkApplyEndObject.Enabled = isEnable;
            if (isEnable)
            {
                pnlRelativeSvGroup.Visible = userInputTempData.isRelative;
                chkEnableSvTo.Visible = userInputTempData.isRelative;
            }
            else
            {
                pnlRelativeSvGroup.Visible = false;
                chkEnableSvTo.Visible = false;
            }
            if (isEnable && !userInputTempData.isSv)
            {
                SetTxtSvFromEnabledState(userInputTempData.isSv);
                SetTxtSvToEnabledState(userInputTempData.isSv);
                SetBtnSwapSvEnabledState(userInputTempData.isSv);
                SetBtnSetSvFromEnabledState(userInputTempData.isSv);
                SetBtnSetSvToEnabledState(userInputTempData.isSv);
            }
            else
            {
                if (userInputTempData.isRelative)
                {
                    chkEnableSv.Enabled = false;
                    SetTxtSvToEnabledState(isEnable ? userInputTempData.isEnableRelativeEnd : isEnable);
                    SetBtnSwapSvEnabledState(isEnable ? userInputTempData.isEnableRelativeEnd : isEnable);
                    SetBtnSetSvToEnabledState(isEnable ? userInputTempData.isEnableRelativeEnd : isEnable);
                }
                else
                {
                    SetTxtSvToEnabledState(isEnable);
                    SetBtnSwapSvEnabledState(isEnable);
                    SetBtnSetSvToEnabledState(isEnable);
                }
                SetTxtSvFromEnabledState(isEnable);
                SetBtnSetSvFromEnabledState(isEnable);
            }
            if (isEnable && !userInputTempData.isVolume)
            {
                SetTxtVolumeFromEnabledState(userInputTempData.isVolume);
                SetTxtVolumeToEnabledState(userInputTempData.isVolume);
                SetBtnSwapVolumeEnabledState(userInputTempData.isVolume);
                SetBtnSetVolumeFromEnabledState(userInputTempData.isVolume);
                SetBtnSetVolumeToEnabledState(userInputTempData.isVolume);
            }
            else
            {
                SetTxtVolumeFromEnabledState(isEnable);
                SetTxtVolumeToEnabledState(isEnable);
                SetBtnSwapVolumeEnabledState(isEnable);
                SetBtnSetVolumeFromEnabledState(isEnable);
                SetBtnSetVolumeToEnabledState(isEnable);
            }

        }
        /// <summary>
        /// Offset有効化チェックボックス(削除)の有効/無効状態に応じたUI設定処理
        /// </summary>
        /// <param name="isEnable">有効化フラグ</param>
        private void SetChkEnableStartOffset(bool isEnable)
        {
            if (chkEnableStartOffset.Checked)
            {
                txtStartOffset.Enabled = true;
                txtStartOffset.BackColor = SystemColors.Window;
                txtStartOffset.ForeColor = SystemColors.WindowText;
            }
            else
            {
                txtStartOffset.Enabled = false;
                txtStartOffset.BackColor = SystemColors.WindowFrame;
                txtStartOffset.ForeColor = SystemColors.WindowFrame;
            }
        }
        #endregion
        #region イベントハンドラ
        private void osuTaikoSVTool_Load(object sender, EventArgs e)
        {
            Common.InitializeDirectoryAndFiles();
            Common.WriteInfoMessage("LOG_I-START");
            // ApplicationExitイベントハンドラを追加
            Application.ApplicationExit += new EventHandler(Application_ApplicationExit);
            // Configファイル設定読み込み
            InitializeConfig();
            // それぞれのコントロールの初期化処理
            InitializeControls();
            InitializeLabelText();
            picDisplayBg.Controls.Add(lblFileName);
            pnlRelativeSvGroup.Visible = false;
            this.FormBorderStyle = FormBorderStyle.FixedSingle;
            this.MaximizeBox = false;
        }
        private void osuTaikoSVTool_Shown(object sender, EventArgs e)
        {
            // 画面がタスクバーと被らないように位置の変更をする
            if (this.WindowState == System.Windows.Forms.FormWindowState.Normal)
            {
                var rect = System.Windows.Forms.Screen.GetWorkingArea(this);
                this.Left = (rect.Left + rect.Width > this.Left + this.Width) ? this.Left : rect.Left + rect.Width - this.Width;
                this.Left = (rect.Left < this.Left) ? this.Left : rect.Left;
                this.Top = (rect.Top + rect.Height > this.Top + this.Height) ? this.Top : rect.Top + rect.Height - this.Height;
                this.Top = (rect.Top < this.Top) ? this.Top : rect.Top;
            }
        }
        private void osuTaikoSVTool_KeyDown(object sender, KeyEventArgs e)
        {
            string backupPath = Directory.GetCurrentDirectory() + Constants.BACKUP_DIRECTORY + "\\" + this.backupDirectoryName;
            switch (e.KeyData)
            {
                //［Ctrl］+［S］が押されたらSV適応/削除を実行する
                case (Keys.S | Keys.Control):
                    switch (tabExecuteType.SelectedIndex)
                    {
                        case 0:
                            btnApply_Click(sender, e);
                            break;
                        case 1:
                            btnRemove_Click(sender, e);
                            break;
                        default:
                            break;
                    }
                    break;
                //［Ctrl］+［Z］が押されたら実行前の譜面にする
                case (Keys.Z | Keys.Control):
                    // 譜面情報がリアルタイムで取得できていない場合はエラーダイアログを表示する
                    if (this.beatmapInfo.beatmapPath == null || this.beatmapInfo.beatmapPath == string.Empty)
                    {
                        Common.ShowMessageDialog("E_A-D-001");
                        return;
                    }
                    // バックアップディレクトリが見つからない場合は何もしない
                    if (!Directory.Exists(backupPath))
                    {
                        break;
                    }
                    if (BeatmapHelper.ExportToPreviousOsuFile(this.beatmapInfo.beatmapPath, this.backupDirectoryName))
                    {
                        // 成功した場合は完了メッセージを表示する
                        Common.ShowMessageDialog("I_A-P-002");
                    }
                    else
                    {
                        // 失敗した場合はエラーダイアログを表示する
                        Common.ShowMessageDialog("E_A-P-001");
                    }
                    break;
                //［Ctrl］+［Shift］+［Z］が押されたら過去の譜面にする
                case (Keys.Z | Keys.Shift | Keys.Control):
                    // 譜面情報がリアルタイムで取得できていない場合はエラーダイアログを表示する
                    if (this.beatmapInfo.beatmapPath == null || this.beatmapInfo.beatmapPath == string.Empty)
                    {
                        Common.ShowMessageDialog("E_A-D-001");
                        return;
                    }
                    // バックアップディレクトリが見つからない場合は何もしない
                    if (!Directory.Exists(backupPath))
                    {
                        break;
                    }
                    BackupForm backupForm = new(backupDirectoryName, this.beatmapInfo.beatmapPath);
                    backupForm.ShowDialog();
                    break;
            }

        }
        private void Application_ApplicationExit(object? sender, EventArgs e)
        {
            //ApplicationExitイベントハンドラを削除
            Application.ApplicationExit -= new EventHandler(Application_ApplicationExit);
            config.ConfigSave();
            Common.WriteInfoMessage("LOG_I-END");
        }
        private void btnBackup_Click(object sender, EventArgs e)
        {
            // バックアップフォルダをエクスプローラで開く
            System.Diagnostics.Process.Start("EXPLORER.EXE", Directory.GetCurrentDirectory() + Constants.BACKUP_DIRECTORY);
        }
        private void btnViewHistory_Click(object sender, EventArgs e)
        {
            // 仮実装
            // 実行履歴画面を表示する
            Form historyForm = new HistoryForm();
            historyForm.ShowDialog();
        }
        private void btnViewSetting_Click(object sender, EventArgs e)
        {
            // 設定画面を表示する
            Form settingForm = new SettingForm(config);
            settingForm.ShowDialog();
            InitializeLabelText();
            if (config.advanceMode == 1)
            {
                chkRelative.Visible = true;
            }
            else
            {
                chkRelative.Checked = false;
                chkRelative.Visible = false;
            }
        }
        // SV helper
        private void txtTimingFrom_Enter(object sender, EventArgs e)
        {
            this.txtTimingFrom.SelectAll();
        }
        private void txtTimingTo_Enter(object sender, EventArgs e)
        {
            this.txtTimingTo.SelectAll();
        }
        private void txtTimingFrom_TextChanged(object sender, EventArgs e)
        {
            userInputTempData.timingFrom = txtTimingFrom.Text;
        }
        private void txtTimingTo_TextChanged(object sender, EventArgs e)
        {
            userInputTempData.timingTo = txtTimingTo.Text;
        }
        private void btnSetTimingFrom_Click(object sender, EventArgs e)
        {
            SetCurrentTimeInfo(txtTimingFrom, Constants.SET_TIMING);
        }
        private void btnSetTimingTo_Click(object sender, EventArgs e)
        {
            SetCurrentTimeInfo(txtTimingTo, Constants.SET_TIMING);
        }
        private void btnSwapTiming_Click(object sender, EventArgs e)
        {
            // Timingの始点と終点を入れ替える
            string timingBuff = "";
            timingBuff = txtTimingFrom.Text;
            txtTimingFrom.Text = txtTimingTo.Text;
            txtTimingTo.Text = timingBuff;
        }
        private void txtSvFrom_Enter(object sender, EventArgs e)
        {
            this.txtSvFrom.SelectAll();
        }
        private void txtSvTo_Enter(object sender, EventArgs e)
        {
            this.txtSvTo.SelectAll();
        }
        private void txtSvFrom_TextChanged(object? sender, EventArgs e)
        {
            if (userInputTempData.isRelative)
            {
                if (userInputTempData.isRelativeMultiply)
                {
                    userInputTempData.relativeMultiplySvFrom = txtSvFrom.Text;
                }
                else if (userInputTempData.isRelativeSum)
                {
                    userInputTempData.relativeSumSvFrom = txtSvFrom.Text;
                }
                else
                {
                    userInputTempData.svFrom = txtSvFrom.Text;
                }
            }
            else
            {
                userInputTempData.svFrom = txtSvFrom.Text;
            }
        }
        private void txtSvTo_TextChanged(object? sender, EventArgs e)
        {
            if (chkRelative.Checked)
            {
                if (rdoRelativeMultiply.Checked)
                {
                    userInputTempData.relativeMultiplySvTo = txtSvTo.Text;
                }
                else if (rdoRelativeSum.Checked)
                {
                    userInputTempData.relativeSumSvTo = txtSvTo.Text;
                }
                else
                {
                    userInputTempData.svTo = txtSvTo.Text;
                }
            }
            else
            {
                userInputTempData.svTo = txtSvTo.Text;
            }
        }
        private void btnSetSvFrom_Click(object sender, EventArgs e)
        {
            SetCurrentTimeInfo(txtSvFrom, Constants.SET_SV);
        }
        private void btnSetSvTo_Click(object sender, EventArgs e)
        {
            SetCurrentTimeInfo(txtSvTo, Constants.SET_SV);
        }
        private void chkEnableSv_CheckedChanged(object? sender, EventArgs e)
        {
            userInputTempData.isSv = chkEnableSv.Checked;
            SetTxtSvFromEnabledState(userInputTempData.isSv);
            SetTxtSvToEnabledState(userInputTempData.isSv);
            SetBtnSwapSvEnabledState(userInputTempData.isSv);
            SetBtnSetSvFromEnabledState(userInputTempData.isSv);
            SetBtnSetSvToEnabledState(userInputTempData.isSv);
            if (userInputTempData.isSv)
            {
                chkRelative.Visible = true;
            }
            else
            {
                chkRelative.Visible = false;
                pnlRelativeSvGroup.Visible = false;
                chkEnableSvTo.Visible = false;
            }
        }
        private void btnSwapSv_Click(object sender, EventArgs e)
        {
            // SVの始点と終点を入れ替える
            string SVBuff = "";
            SVBuff = txtSvFrom.Text;
            txtSvFrom.Text = txtSvTo.Text;
            txtSvTo.Text = SVBuff;
        }
        private void txtVolumeFrom_Enter(object sender, EventArgs e)
        {
            this.txtVolumeFrom.SelectAll();
        }
        private void txtVolumeTo_Enter(object sender, EventArgs e)
        {
            this.txtVolumeTo.SelectAll();
        }
        private void txtVolumeFrom_TextChanged(object sender, EventArgs e)
        {
            userInputTempData.volumeFrom = txtVolumeFrom.Text;
        }
        private void txtVolumeTo_TextChanged(object sender, EventArgs e)
        {
            userInputTempData.volumeTo = txtVolumeTo.Text;
        }
        private void btnSetVolumeFrom_Click(object sender, EventArgs e)
        {
            SetCurrentTimeInfo(txtVolumeFrom, Constants.SET_VOLUME);
        }
        private void btnSetVolumeTo_Click(object sender, EventArgs e)
        {
            SetCurrentTimeInfo(txtVolumeTo, Constants.SET_VOLUME);
        }
        private void btnSwapVolume_Click(object sender, EventArgs e)
        {
            // Volumeの始点と終点を入れ替える
            string volumeBuff = "";
            volumeBuff = txtVolumeFrom.Text;
            txtVolumeFrom.Text = txtVolumeTo.Text;
            txtVolumeTo.Text = volumeBuff;

        }
        private void chkEnableVolume_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isVolume = chkEnableVolume.Checked;
            SetTxtVolumeFromEnabledState(userInputTempData.isVolume);
            SetTxtVolumeToEnabledState(userInputTempData.isVolume);
            SetBtnSwapVolumeEnabledState(userInputTempData.isVolume);
            SetBtnSetVolumeFromEnabledState(userInputTempData.isVolume);
            SetBtnSetVolumeToEnabledState(userInputTempData.isVolume);
        }
        private void chkApplyStartObject_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isEnableFrom = chkApplyStartObject.Checked;
        }
        private void chkApplyEndObject_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isEnableTo = chkApplyEndObject.Checked;
        }
        private void rdoArithmetic_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isArithmetic = rdoArithmetic.Checked;
        }
        private void rdoGeometric_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isGeometric = rdoGeometric.Checked;
        }
        private void chkRelative_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isRelative = chkRelative.Checked;
            bool isEnable = userInputTempData.isRelative ?
                userInputTempData.isEnableRelativeEnd : userInputTempData.isSv;
            SetRelativeEnabledState(userInputTempData.isRelative);
            SetTxtSvToEnabledState(isEnable);
            SetBtnSwapSvEnabledState(isEnable);
            SetBtnSetSvToEnabledState(isEnable);
        }
        private void rdoRelativeMultiply_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isRelativeMultiply = rdoRelativeMultiply.Checked;
            SetRelativeMultiplyEnableState(userInputTempData.isRelativeMultiply);
        }
        private void txtRelativeBaseSv_TextChanged(object sender, EventArgs e)
        {
            userInputTempData.relativeMultiplyBaseSv = txtRelativeBaseSv.Text;
        }
        private void rdoRelativeSum_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isRelativeSum = rdoRelativeSum.Checked;
            if (userInputTempData.isRelativeSum)
            {
                txtSvFrom.Text = userInputTempData.relativeSumSvFrom;
                txtSvTo.Text = userInputTempData.relativeSumSvTo;
            }
        }
        private void chkEnableSvTo_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isEnableRelativeEnd = chkEnableSvTo.Checked;
            SetTxtSvToEnabledState(userInputTempData.isEnableRelativeEnd);
            SetBtnSwapSvEnabledState(userInputTempData.isEnableRelativeEnd);
            SetBtnSetSvToEnabledState(userInputTempData.isEnableRelativeEnd);
        }
        private void chkEnableOffset_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isOffset = chkEnableOffset.Checked;
            SetChkEnableOffset(userInputTempData.isOffset);
        }
        private void txtOffset_TextChanged(object sender, EventArgs e)
        {
            userInputTempData.offset = txtOffset.Text;
        }
        private void chkEnableKiai_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isKiai = chkEnableKiai.Checked;
        }
        private void tabExecuteType_SelectedIndexChanged(object sender, EventArgs e)
        {
            switch (tabExecuteType.SelectedIndex)
            {
                case 0:
                    // Apply
                    SetApplyControls(true);
                    break;
                case 1:
                    // Remove
                    SetApplyControls(false);
                    break;
                default:
                    break;
            }
        }
        private void btnApply_Click(object sender, EventArgs e)
        {
            try
            {
                // 入力値をUserInputDataクラスに格納
                if (!UserInputDataHelper.SetUserInputData(userInputTempData,
                                                          Constants.EXECUTE_APPLY,
                                                          ref userInputData))
                {
                    return;
                }
                // 譜面情報の取得
                if (!GetBeatmap())
                {
                    Common.ShowMessageDialog("E_A-D-001");
                    return;
                }
                // 追加処理の実行
                ExecuteProcess(Constants.EXECUTE_APPLY);
            }
            catch (Exception ex)
            {
                Common.WriteErrorMessage("LOG_E-EXCEPTION");
                Common.WriteExceptionMessage(ex);
                return;
            }
            finally
            {
                beatmapData = null;
                userInputData = new();
            }
        }
        private void tabSetType_SelectedIndexChanged(object sender, EventArgs e)
        {
            switch (tabSetType.SelectedIndex)
            {
                case 0:
                    // HitObjects
                    userInputTempData.setOption.isSetObjects = true;
                    userInputTempData.setOption.isSetBeatSnap = false;
                    userInputTempData.setOption.isSetGreenLine = false;
                    InitializeHitObjectsControls();
                    break;
                case 1:
                    // BeatSnap
                    userInputTempData.setOption.isSetObjects = false;
                    userInputTempData.setOption.isSetBeatSnap = true;
                    userInputTempData.setOption.isSetGreenLine = false;
                    InitializeBeatSnapControls();
                    break;
                case 2:
                    // GreenLine
                    userInputTempData.setOption.isSetObjects = false;
                    userInputTempData.setOption.isSetBeatSnap = false;
                    userInputTempData.setOption.isSetGreenLine = true;
                    InitializeGreenLineControls();
                    break;
                default:
                    break;
            }
        }
        private void rdoAllHitObjects_CheckedChanged(object sender, EventArgs e)
        {
            if (rdoAllHitObjects.Checked)
            {
                // すべてのobject関連のコントロールを有効化
                rdoOnlyOnNotes.Visible = false;
                rdoOnlyOffNotes.Visible = false;
            }
            userInputTempData.setObjectOption.isAllHitObjects = rdoAllHitObjects.Checked;
        }
        private void rdoOnlyBarline_CheckedChanged(object sender, EventArgs e)
        {
            if (rdoOnlyBarline.Checked)
            {
                rdoOnlyOnNotes.Visible = true;
                rdoOnlyOffNotes.Visible = true;
                rdoOnlyOnNotes.Checked = userInputTempData.setObjectOption.isOnBarlines;
                rdoOnlyOffNotes.Checked = userInputTempData.setObjectOption.isOffBarlines;
                rdoOnlyOnNotes.CheckedChanged += rdoOnlyOnNotes_CheckedChanged;
                rdoOnlyOffNotes.CheckedChanged += rdoOnlyOffNotes_CheckedChanged;
                Common.SetLabelText(rdoOnlyOnNotes, "LBL_ON_BARLINE");
                Common.SetLabelText(rdoOnlyOffNotes, "LBL_OFF_BARLINE");
            }
            else
            {
                rdoOnlyOnNotes.CheckedChanged -= rdoOnlyOnNotes_CheckedChanged;
                rdoOnlyOffNotes.CheckedChanged -= rdoOnlyOffNotes_CheckedChanged;
            }
            userInputTempData.setObjectOption.isOnlyBarlines = rdoOnlyBarline.Checked;
        }
        private void rdoOnlyBookMark_CheckedChanged(object sender, EventArgs e)
        {
            if (rdoOnlyBookMark.Checked)
            {
                // Tabコントロール内のコントロールをすべて無効化
                chkEnableOffset.Visible = false;
                txtOffset.Visible = false;
                lblMiliSecond.Visible = false;
                rdoOnlyOnNotes.Visible = true;
                rdoOnlyOffNotes.Visible = true;
                rdoOnlyOnNotes.Checked = userInputTempData.setObjectOption.isOnBookmarks;
                rdoOnlyOffNotes.Checked = userInputTempData.setObjectOption.isOffBookmarks;
                rdoOnlyOnNotes.CheckedChanged += rdoOnlyOnNotes_CheckedChanged;
                rdoOnlyOffNotes.CheckedChanged += rdoOnlyOffNotes_CheckedChanged;
                Common.SetLabelText(rdoOnlyOnNotes, "LBL_ON_BOOKMARK");
                Common.SetLabelText(rdoOnlyOffNotes, "LBL_OFF_BOOKMARK");
            }
            else
            {
                // Tabコントロール内のコントロールを有効化
                chkEnableOffset.Visible = true;
                txtOffset.Visible = true;
                lblMiliSecond.Visible = true;
                rdoOnlyOnNotes.CheckedChanged -= rdoOnlyOnNotes_CheckedChanged;
                rdoOnlyOffNotes.CheckedChanged -= rdoOnlyOffNotes_CheckedChanged;
            }
            userInputTempData.setObjectOption.isOnlyBookmarks = rdoOnlyBookMark.Checked;
        }
        private void rdoOnlyOnNotes_CheckedChanged(object? sender, EventArgs e)
        {
            if (rdoOnlyBarline.Checked)
            {
                userInputTempData.setObjectOption.isOnBarlines = rdoOnlyOnNotes.Checked;
            }
            else if (rdoOnlyBookMark.Checked)
            {
                userInputTempData.setObjectOption.isOnBookmarks = rdoOnlyOnNotes.Checked;
            }
        }
        private void rdoOnlyOffNotes_CheckedChanged(object? sender, EventArgs e)
        {
            if (rdoOnlyBarline.Checked)
            {
                userInputTempData.setObjectOption.isOffBarlines = rdoOnlyOffNotes.Checked;
            }
            else if (rdoOnlyBookMark.Checked)
            {
                userInputTempData.setObjectOption.isOffBookmarks = rdoOnlyOffNotes.Checked;
            }
        }
        private void rdoOnlySpecificHitObject_CheckedChanged(object sender, EventArgs e)
        {
            if (rdoOnlySpecificHitObject.Checked)
            {
                // 特定のobject関連のコントロールを有効化
                picSpecificNormalDong.Visible = true;
                picSpecificFinisherDong.Visible = true;
                picSpecificNormalKa.Visible = true;
                picSpecificFinisherKa.Visible = true;
                picSpecificNormalSlider.Visible = true;
                picSpecificFinisherSlider.Visible = true;
                picSpecificNormalSpinner.Visible = true;
                lblSpecificNormal.Visible = true;
                lblSpecificFinisher.Visible = true;
                lblSpecificGridLine.Visible = true;
                lblSpecificGridLine2.Visible = true;
                // pictureBoxに設定されているMouseDownイベントを設定する
                picSpecificNormalDong.MouseDown += picSpecificNormalDong_MouseDown;
                picSpecificFinisherDong.MouseDown += picSpecificFinisherDong_MouseDown;
                picSpecificNormalKa.MouseDown += picSpecificNormalKa_MouseDown;
                picSpecificFinisherKa.MouseDown += picSpecificFinisherKa_MouseDown;
                picSpecificNormalSlider.MouseDown += picSpecificNormalSlider_MouseDown;
                picSpecificFinisherSlider.MouseDown += picSpecificFinisherSlider_MouseDown;
                picSpecificNormalSpinner.MouseDown += picSpecificNormalSpinner_MouseDown;
                rdoOnlyOnNotes.Visible = false;
                rdoOnlyOffNotes.Visible = false;
            }
            else
            {
                // 特定のobject関連のコントロールを無効化
                picSpecificNormalDong.Visible = false;
                picSpecificFinisherDong.Visible = false;
                picSpecificNormalKa.Visible = false;
                picSpecificFinisherKa.Visible = false;
                picSpecificNormalSlider.Visible = false;
                picSpecificFinisherSlider.Visible = false;
                picSpecificNormalSpinner.Visible = false;
                lblSpecificNormal.Visible = false;
                lblSpecificFinisher.Visible = false;
                lblSpecificGridLine.Visible = false;
                lblSpecificGridLine2.Visible = false;
                // pictureBoxに設定されているMouseDownイベントを外す
                picSpecificNormalDong.MouseDown -= picSpecificNormalDong_MouseDown;
                picSpecificFinisherDong.MouseDown -= picSpecificFinisherDong_MouseDown;
                picSpecificNormalKa.MouseDown -= picSpecificNormalKa_MouseDown;
                picSpecificFinisherKa.MouseDown -= picSpecificFinisherKa_MouseDown;
                picSpecificNormalSlider.MouseDown -= picSpecificNormalSlider_MouseDown;
                picSpecificFinisherSlider.MouseDown -= picSpecificFinisherSlider_MouseDown;
                picSpecificNormalSpinner.MouseDown -= picSpecificNormalSpinner_MouseDown;
            }
            userInputTempData.setObjectOption.isOnlyHitObjects = rdoOnlySpecificHitObject.Checked;
        }
        private void picSpecificNormalDong_MouseDown(object? sender, MouseEventArgs e)
        {
            userInputTempData.setObjectOption.isOnlyNormalDong = !userInputTempData.setObjectOption.isOnlyNormalDong;
            picSpecificNormalDong.Image = userInputTempData.setObjectOption.isOnlyNormalDong ?
                          Properties.Resources.d_selected : Properties.Resources.d;
        }
        private void picSpecificFinisherDong_MouseDown(object? sender, MouseEventArgs e)
        {
            userInputTempData.setObjectOption.isOnlyFinisherDong = !userInputTempData.setObjectOption.isOnlyFinisherDong;
            picSpecificFinisherDong.Image = userInputTempData.setObjectOption.isOnlyFinisherDong ?
                        Properties.Resources.d_selected : Properties.Resources.d;

        }
        private void picSpecificNormalKa_MouseDown(object? sender, MouseEventArgs e)
        {
            userInputTempData.setObjectOption.isOnlyNormalKa = !userInputTempData.setObjectOption.isOnlyNormalKa;
            picSpecificNormalKa.Image = userInputTempData.setObjectOption.isOnlyNormalKa ?
                        Properties.Resources.k_selected : Properties.Resources.k;
        }
        private void picSpecificFinisherKa_MouseDown(object? sender, MouseEventArgs e)
        {
            userInputTempData.setObjectOption.isOnlyFinisherKa = !userInputTempData.setObjectOption.isOnlyFinisherKa;
            picSpecificFinisherKa.Image = userInputTempData.setObjectOption.isOnlyFinisherKa ?
                        Properties.Resources.k_selected : Properties.Resources.k;
        }
        private void picSpecificNormalSlider_MouseDown(object? sender, MouseEventArgs e)
        {
            userInputTempData.setObjectOption.isOnlyNormalSlider = !userInputTempData.setObjectOption.isOnlyNormalSlider;
            picSpecificNormalSlider.Image = userInputTempData.setObjectOption.isOnlyNormalSlider ?
                        Properties.Resources.slider_selected : Properties.Resources.slider;
        }
        private void picSpecificFinisherSlider_MouseDown(object? sender, MouseEventArgs e)
        {
            userInputTempData.setObjectOption.isOnlyFinisherSlider = !userInputTempData.setObjectOption.isOnlyFinisherSlider;
            picSpecificFinisherSlider.Image = userInputTempData.setObjectOption.isOnlyFinisherSlider ?
                        Properties.Resources.slider_selected : Properties.Resources.slider;
        }
        private void picSpecificNormalSpinner_MouseDown(object? sender, MouseEventArgs e)
        {
            userInputTempData.setObjectOption.isOnlySpinner = !userInputTempData.setObjectOption.isOnlySpinner;
            picSpecificNormalSpinner.Image = userInputTempData.setObjectOption.isOnlySpinner ?
                        Properties.Resources.spinner_selected : Properties.Resources.spinner;
        }
        private void chkEnableBeatSnap_CheckedChanged(object? sender, EventArgs e)
        {
            if (chkEnableBeatSnap.Checked)
            {
                // beatsnap関連のコントロールを有効化
                txtBeatSnap.BackColor = SystemColors.Window;
                txtBeatSnap.Enabled = true;
                txtBeatSnap.Text = userInputTempData.setBeatSnapOption.beatSnap;
                txtBeatSnap.TextChanged += txtBeatSnap_TextChanged;
            }
            else
            {
                // beatsnap関連のコントロールを無効化
                txtBeatSnap.BackColor = SystemColors.WindowFrame;
                txtBeatSnap.Enabled = false;
                txtBeatSnap.Text = string.Empty;
                txtBeatSnap.TextChanged -= txtBeatSnap_TextChanged;
            }
            userInputTempData.setBeatSnapOption.isBeatSnap = chkEnableBeatSnap.Checked;
        }
        private void txtBeatSnap_TextChanged(object? sender, EventArgs e)
        {
            userInputTempData.setBeatSnapOption.beatSnap = txtBeatSnap.Text;
        }
        private void btnRemove_Click(object sender, EventArgs e)
        {
            try
            {
                // 入力値をUserInputDataクラスに格納
                if (!UserInputDataHelper.SetUserInputData(userInputTempData,
                                                          Constants.EXECUTE_REMOVE,
                                                          ref userInputData))
                {
                    return;
                }
                // 譜面情報の取得
                if (!GetBeatmap())
                {
                    Common.ShowMessageDialog("E_A-D-001");
                    return;
                }
                // 削除処理の実行
                ExecuteProcess(Constants.EXECUTE_REMOVE);
            }
            catch (Exception ex)
            {
                Common.WriteErrorMessage("LOG_E-EXCEPTION");
                Common.WriteExceptionMessage(ex);
                return;
            }
            finally
            {
                beatmapData = null;
                userInputData = new();
            }
        }
        private void txtStartOffset_TextChanged(object sender, EventArgs e)
        {
            userInputTempData.offset = txtStartOffset.Text;
        }
        private void chkEnableStartOffset_CheckedChanged(object sender, EventArgs e)
        {
            userInputTempData.isOffset = chkEnableStartOffset.Checked;
            SetChkEnableStartOffset(userInputTempData.isOffset);
        }
        #endregion
    }
}